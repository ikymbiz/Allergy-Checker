<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Allergy Checker</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --success: #10b981;
            --unsure: #6b7280;
            --amazon: #232f3e;
            --bg: #f8fafc;
            --card: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg); margin: 0; padding: 15px; color: #1e293b;
            line-height: 1.5;
        }

        .container {
            max-width: 500px; margin: auto; background: var(--card); padding: 25px;
            border-radius: 32px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            position: relative; overflow: hidden;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px;
        }

        h3 { margin: 0; font-size: 1.25rem; font-weight: 800; color: #0f172a; }

        select {
            padding: 8px 12px; border-radius: 12px; border: 1px solid #e2e8f0;
            background: #f1f5f9; font-size: 14px; font-weight: 600; cursor: pointer; outline: none;
        }

        .settings {
            background: #f8fafc; padding: 16px; border-radius: 20px;
            margin-bottom: 20px; font-size: 13px; border: 1px solid #e2e8f0;
        }

        summary { font-weight: 700; cursor: pointer; color: #64748b; margin-bottom: 5px; }

        input[type="text"] {
            width: 100%; padding: 12px 16px; margin: 8px 0; border: 1px solid #e2e8f0;
            border-radius: 12px; box-sizing: border-box; font-size: 14px; outline: none; transition: 0.2s;
        }

        .preview-wrapper {
            position: relative; width: 100%; border-radius: 24px; overflow: hidden;
            background: #0f172a; aspect-ratio: 1/1; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
        }

        video, #file-preview { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* „Çπ„Ç≠„É£„É≥Á∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: var(--primary);
            top: 0; left: 0; z-index: 5; display: none;
            box-shadow: 0 0 15px var(--primary);
            animation: scan 2s linear infinite;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        #loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(4px);
        }

        .spinner {
            width: 48px; height: 48px; border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s infinite linear; margin-bottom: 12px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        button {
            padding: 16px; font-size: 15px; cursor: pointer; border: none;
            border-radius: 16px; font-weight: 700; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-capture { background: var(--primary); color: white; grid-column: span 2; }
        .btn-file, .btn-torch { background: #f1f5f9; color: #475569; }

        .alert-box { padding: 24px; border-radius: 24px; margin-top: 20px; border-top: 8px solid #ccc; text-align: center; }
        .alert-face { font-size: 64px; display: block; margin-bottom: 10px; }
        .alert-status-text { font-size: 24px; font-weight: 900; display: block; margin-bottom: 10px; }

        .alert-critical { background: #fef2f2; border-color: var(--danger); color: var(--danger); }
        .alert-warning { background: #fffbeb; border-color: var(--warning); color: var(--warning); }
        .alert-safe { background: #f0fdf4; border-color: var(--success); color: var(--success); }
        .alert-info { background: #eff6ff; border-color: var(--info); color: var(--info); }

        .tag { display: inline-block; padding: 6px 12px; border-radius: 10px; margin: 4px; font-size: 12px; font-weight: 700; background: rgba(0,0,0,0.06); }
        .btn-amazon { display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--amazon); color: white; text-decoration: none; padding: 16px; border-radius: 16px; font-weight: 700; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h3 id="ui-title">Global AI Checker</h3>
        <select id="lang-selector">
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="en">English</option>
            <option value="zh">ÁÆÄ‰Ωì‰∏≠Êñá</option>
            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
            <option value="es">Espa√±ol</option>
        </select>
    </div>

    <details class="settings">
        <summary id="ui-settings-label">‚öôÔ∏è Settings</summary>
        <div style="padding-top:10px;">
            <label id="ui-diet-label" style="font-weight:700; color:#475569;">Restricted Ingredients:</label>
            <input type="text" id="my-diet" placeholder="e.g. Peanut, Vegan, Halal">
            <button id="ui-save-btn" style="background:#1e293b; width:100%; color:white; padding:12px; border-radius:12px; margin-top:8px;">SAVE</button>
        </div>
    </details>

    <div class="preview-wrapper">
        <div id="loading-overlay">
            <div class="spinner"></div>
            <p id="ui-loading-text" style="font-weight:700; color:#1e293b;"></p>
        </div>
        <div class="scan-line" id="scan-line"></div>
        <div id="placeholder-text" style="color:#94a3b8;">Press START SCAN</div>
        <video id="video" autoplay playsinline muted></video>
        <img id="file-preview">
    </div>

    <div class="controls">
        <button class="btn-capture" id="ui-scan-btn">üîç START SCAN</button>
        <button class="btn-torch" id="ui-torch-btn">üî¶ LIGHT</button>
        <button class="btn-file" id="ui-file-btn">üìÅ PHOTO</button>
        <input type="file" id="image-input" accept="image/*" style="display:none;">
    </div>

    <div id="result-area"></div>
</div>

<script>
    const i18n = {
        ja: { scan: "üîç „Çπ„Ç≠„É£„É≥ÈñãÂßã", capture: "üì∏ Âà§ÂÆö„Åô„Çã", hold: "Âãï„Åã„Åï„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ...", loading: "AI„ÅåÂàÜÊûê‰∏≠...", safe: "„Åü„Åπ„Å¶OKÔºÅ", warning: "Ê≥®ÊÑè„ÅåÂøÖË¶Å", critical: "„Å†„ÇÅ„Å†„ÇàÔºÅ", unsure: "Âà§Âà•‰∏çËÉΩ", info: "„Å™„Åæ„Åà„Çí„Åø„Åõ„Å¶", btnSafe: "üõí Amazon„Åß„ÇÇ„Å£„Å®Ë¶ã„Çã", btnAlert: "üîç ‰ª£„Çè„Çä„ÇíAmazon„ÅßÊé¢„Åô", settings: "‚öôÔ∏è Ë®≠ÂÆö", diet: "È£ü„Åπ„Çâ„Çå„Å™„ÅÑ„ÇÇ„ÅÆ:", save: "Ë®≠ÂÆö„Çí‰øùÂ≠ò", amz: "amazon.co.jp" },
        en: { scan: "üîç START SCAN", capture: "üì∏ CAPTURE", hold: "Hold steady...", loading: "Analyzing...", safe: "SAFE TO EAT", warning: "BE CAREFUL", critical: "DO NOT EAT", unsure: "UNSURE", info: "NEED NAME", btnSafe: "üõí Buy more on Amazon", btnAlert: "üîç Find Alternatives", settings: "‚öôÔ∏è Settings", diet: "Restrictions:", save: "SAVE", amz: "amazon.com" },
        zh: { scan: "üîç ÂºÄÂßãÊâ´Êèè", capture: "üì∏ ÊãçÊëÑÂà§ÂÆö", hold: "ËØ∑‰øùÊåÅÁ®≥ÂÆö...", loading: "Ê≠£Âú®ÂàÜÊûê...", safe: "ÂèØ‰ª•È£üÁî®", warning: "ËØ∑Ê≥®ÊÑè", critical: "‰∏çÂèØÈ£üÁî®", unsure: "Êó†Ê≥ïÂà§Êñ≠", info: "ËØ∑Âá∫Á§∫ÂïÜÂìÅÂêç", btnSafe: "üõí Âú®AmazonË¥≠‰π∞Êõ¥Â§ö", btnAlert: "üîç Âú®AmazonÊü•ÊâæÊõø‰ª£ÂìÅ", settings: "‚öôÔ∏è ËÆæÁΩÆ", diet: "Á¶ÅÂøåÊàêÂàÜ:", save: "‰øùÂ≠òËÆæÁΩÆ", amz: "amazon.com" },
        ko: { scan: "üîç Ïä§Ï∫î ÏãúÏûë", capture: "üì∏ Ï¥¨ÏòÅ ÌåêÏ†ï", hold: "ÏõÄÏßÅÏù¥ÏßÄ ÎßàÏÑ∏Ïöî...", loading: "Î∂ÑÏÑù Ï§ë...", safe: "Î®πÏñ¥ÎèÑ Ï¢ãÏïÑÏöî", warning: "Ï£ºÏùò ÌïÑÏöî", critical: "Î®πÏúºÎ©¥ Ïïà ÎèºÏöî", unsure: "ÌåêÎ≥Ñ Î∂àÍ∞Ä", info: "ÏÉÅÌíàÎ™ÖÏùÑ Î≥¥Ïó¨Ï£ºÏÑ∏Ïöî", btnSafe: "üõí AmazonÏóêÏÑú Îçî Î≥¥Í∏∞", btnAlert: "üîç AmazonÏóêÏÑú ÎåÄÏ≤¥Ìíà Ï∞æÍ∏∞", settings: "‚öôÔ∏è ÏÑ§Ï†ï", diet: "Ï†úÌïú ÏÑ±ÂàÜ:", save: "Ï†ÄÏû•ÌïòÍ∏∞", amz: "amazon.com" },
        es: { scan: "üîç INICIAR", capture: "üì∏ CAPTURAR", hold: "Mantenga estable...", loading: "Analizando...", safe: "APTO PARA COMER", warning: "TENER CUIDADO", critical: "NO COMER", unsure: "NO ESTOY SEGURO", info: "MOSTRAR NOMBRE", btnSafe: "üõí Ver en Amazon", btnAlert: "üîç Buscar en Amazon", settings: "‚öôÔ∏è Ajustes", diet: "Restricciones:", save: "GUARDAR", amz: "amazon.es" }
    };

    let currentLang = localStorage.getItem('ui_lang') || 'ja';
    let cameraStream = null;
    const AMAZON_ID = "ddeberias-22";

    window.onload = () => {
        document.getElementById('lang-selector').value = currentLang;
        updateUIStrings();
    };

    document.getElementById('lang-selector').onchange = (e) => {
        currentLang = e.target.value;
        localStorage.setItem('ui_lang', currentLang);
        updateUIStrings();
    };

    function updateUIStrings() {
        const t = i18n[currentLang] || i18n.en;
        document.getElementById('ui-scan-btn').innerText = cameraStream ? t.capture : t.scan;
        document.getElementById('ui-settings-label').innerText = t.settings;
        document.getElementById('ui-diet-label').innerText = t.diet;
        document.getElementById('ui-save-btn').innerText = t.save;
        document.getElementById('my-diet').value = localStorage.getItem('my_diet') || "";
    }

    async function handleScanButton() {
        if (!cameraStream) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                const video = document.getElementById('video');
                video.srcObject = cameraStream;
                video.style.display = "block";
                document.getElementById('scan-line').style.display = "block";
                document.getElementById('placeholder-text').style.display = "none";
                updateUIStrings();
            } catch (err) { alert("Camera Access Error"); }
        } else {
            captureAndExecute();
        }
    }

    async function captureAndExecute() {
        const t = i18n[currentLang] || i18n.en;
        document.getElementById('loading-overlay').style.display = "flex";
        document.getElementById('ui-loading-text').innerText = t.hold;

        const canvas = document.createElement('canvas');
        const video = document.getElementById('video');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const base64 = canvas.toDataURL('image/jpeg', 0.95).split(',')[1];
        stopCamera();

        callAnalyze(base64);
    }

    function stopCamera() {
        if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; }
        document.getElementById('video').style.display = "none";
        document.getElementById('scan-line').style.display = "none";
        updateUIStrings();
    }

    async function callAnalyze(base64Data) {
        const t = i18n[currentLang] || i18n.en;
        document.getElementById('ui-loading-text').innerText = t.loading;

        try {
            // Vercel Serverless Function (/api/analyze) „ÇíÂëº„Å≥Âá∫„Åô
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageBase64: base64Data,
                    myDiet: document.getElementById('my-diet').value,
                    lang: currentLang
                })
            });

            if (!response.ok) throw new Error("Server Error");

            const res = await response.json();
            renderResult(res);
        } catch (e) {
            alert("Analysis failed. Please try again.");
            console.error(e);
        } finally {
            document.getElementById('loading-overlay').style.display = "none";
        }
    }

    function renderResult(res) {
        const t = i18n[currentLang] || i18n.en;
        let alertClass = "alert-safe", face = "üòä", statusText = t.safe;

        if (res.status === "critical") { alertClass = "alert-critical"; face = "üò´"; statusText = t.critical; }
        else if (res.status === "warning") { alertClass = "alert-warning"; face = "ü§î"; statusText = t.warning; }
        else if (res.status === "info") { alertClass = "alert-info"; face = "üëÄ"; statusText = t.info; }

        const isSafe = (res.status === "safe");
        const searchKeyword = isSafe ? (res.product_name || "Food") : (res.product_name + " " + (res.matches || []).join(" "));
        const amazonUrl = `https://www.${t.amz}/s?k=${encodeURIComponent(searchKeyword)}&tag=${AMAZON_ID}`;

        document.getElementById('result-area').innerHTML = `
            <div class="alert-box ${alertClass}">
                <span class="alert-face">${face}</span>
                <span class="alert-status-text">${statusText}</span>
                <h3 style="margin:10px 0;">${res.product_name || ''}</h3>
                <p style="font-weight:bold; line-height:1.4;">${res.suitability_note}</p>
                <div style="margin-bottom:10px;">${(res.matches || []).map(m => `<span class="tag">${m}</span>`).join('')}</div>
                <a href="${amazonUrl}" target="_blank" class="btn-amazon">${isSafe ? t.btnSafe : t.btnAlert}</a>
            </div>
        `;
    }

    document.getElementById('ui-scan-btn').onclick = handleScanButton;
    document.getElementById('ui-save-btn').onclick = () => {
        localStorage.setItem('my_diet', document.getElementById('my-diet').value);
        alert("Saved!");
    };
    document.getElementById('ui-file-btn').onclick = () => document.getElementById('image-input').click();
    document.getElementById('image-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => callAnalyze(ev.target.result.split(',')[1]);
        reader.readAsDataURL(e.target.files[0]);
    };
</script>
</body>
</html>
