<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Allergy Checker AI</title>
    <style>
        /* CSS„ÅØÂÖÉ„ÅÆ„Éá„Ç∂„Ç§„É≥„ÇíÁ∂≠ÊåÅ (‰∏ÄÈÉ®ÁúÅÁï•„ÄÅÂÖ±ÈÄö) */
        :root { --primary: #2563eb; --danger: #ef4444; --warning: #f59e0b; --success: #10b981; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #1e293b; }
        .container { max-width: 500px; margin: auto; background: var(--card); padding: 25px; border-radius: 32px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .preview-wrapper { position: relative; width: 100%; border-radius: 24px; overflow: hidden; background: #0f172a; aspect-ratio: 1/1; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; }
        video, #file-preview { width: 100%; height: 100%; object-fit: cover; }
        #loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(4px); }
        .spinner { width: 48px; height: 48px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 16px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-capture { background: var(--primary); color: white; grid-column: span 2; }
        .alert-box { padding: 24px; border-radius: 24px; margin-top: 20px; border-top: 8px solid #ccc; text-align: center; }
        .alert-critical { background: #fef2f2; border-color: var(--danger); color: var(--danger); }
        .alert-safe { background: #f0fdf4; border-color: var(--success); color: var(--success); }
        .tag { display: inline-block; padding: 4px 8px; border-radius: 8px; margin: 2px; background: rgba(0,0,0,0.05); font-size: 12px; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: var(--primary); top: 0; z-index: 5; display: none; animation: scan 2s linear infinite; box-shadow: 0 0 15px var(--primary); }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h3>Allergy Checker AI</h3>
        <select id="lang-selector" onchange="changeLanguage()">
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="en">English</option>
        </select>
    </div>

    <details class="settings">
        <summary id="ui-settings-label">‚öôÔ∏è Settings</summary>
        <div style="padding-top:10px;">
            <label style="font-weight:700; color:#475569;" id="ui-diet-label">Restricted Ingredients:</label>
            <input type="text" id="my-diet" placeholder="‰æã: Â∞èÈ∫¶, ‰π≥Ë£ΩÂìÅ, Vegan">
            <button onclick="saveSettings()" style="background:#1e293b; width:100%; color:white; padding:12px; border-radius:12px; margin-top:8px;" id="ui-save-btn">SAVE</button>
        </div>
    </details>

    <div class="preview-wrapper">
        <div id="loading-overlay">
            <div class="spinner"></div>
            <p id="ui-loading-text" style="font-weight:700;"></p>
        </div>
        <div class="scan-line" id="scan-line"></div>
        <video id="video" autoplay playsinline muted></video>
        <img id="file-preview" style="display:none;">
    </div>

    <div class="controls">
        <button class="btn-capture" onclick="handleScanButton()" id="ui-scan-btn">üîç START SCAN</button>
        <button onclick="toggleTorch()" id="ui-torch-btn" style="background:#f1f5f9;">üî¶ LIGHT</button>
        <button onclick="document.getElementById('image-input').click()" style="background:#f1f5f9;">üìÅ PHOTO</button>
        <input type="file" id="image-input" accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
    </div>

    <div id="result-area"></div>
</div>

<script>
    const i18n = {
        ja: { scan: "üîç „Çπ„Ç≠„É£„É≥ÈñãÂßã", capture: "üì∏ Âà§ÂÆö„Åô„Çã", hold: "Âãï„Åã„Åï„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ...", loading: "AIÂàÜÊûê‰∏≠...", safe: "„Åü„Åπ„Å¶OKÔºÅ", critical: "„Å†„ÇÅ„Å†„ÇàÔºÅ", amz: "amazon.co.jp" },
        en: { scan: "üîç START SCAN", capture: "üì∏ CAPTURE", hold: "Hold steady...", loading: "Analyzing...", safe: "SAFE TO EAT", critical: "DO NOT EAT", amz: "amazon.com" }
    };

    let currentLang = 'ja';
    let cameraStream = null;

    window.onload = () => {
        currentLang = localStorage.getItem('ui_lang') || 'ja';
        document.getElementById('lang-selector').value = currentLang;
        document.getElementById('my-diet').value = localStorage.getItem('my_diet') || "";
        changeLanguage();
    };

    function changeLanguage() {
        currentLang = document.getElementById('lang-selector').value;
        localStorage.setItem('ui_lang', currentLang);
        const t = i18n[currentLang] || i18n.en;
        document.getElementById('ui-scan-btn').innerText = cameraStream ? t.capture : t.scan;
    }

    async function handleScanButton() {
        if (!cameraStream) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('video').srcObject = cameraStream;
                document.getElementById('video').style.display = "block";
                document.getElementById('scan-line').style.display = "block";
                changeLanguage();
            } catch (err) { alert("Camera Error"); }
        } else {
            capture();
        }
    }

    async function capture() {
        const t = i18n[currentLang] || i18n.en;
        document.getElementById('loading-overlay').style.display = "flex";
        document.getElementById('ui-loading-text').innerText = t.hold;

        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');

        // --- Á≤æÂ∫¶Á∂≠ÊåÅ„Å®„Ç®„É©„ÉºÂõûÈÅø„ÅÆ„Åü„ÇÅ„ÅÆ„É™„Çµ„Ç§„Ç∫ ---
        const MAX_W = 1280;
        let w = video.videoWidth, h = video.videoHeight;
        if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(video, 0, 0, w, h);

        // ÁîªË≥™0.6„ÅßËªΩÈáèÂåñ
        const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

        stopCamera();
        analyze(base64);
    }

    function stopCamera() {
        if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
        document.getElementById('video').style.display = "none";
        document.getElementById('scan-line').style.display = "none";
        changeLanguage();
    }

    async function analyze(base64) {
        const t = i18n[currentLang] || i18n.en;
        document.getElementById('ui-loading-text').innerText = t.loading;

        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageBase64: base64,
                    myDiet: document.getElementById('my-diet').value,
                    lang: currentLang
                })
            });
            const data = await res.json();
            renderResult(data);
        } catch (e) {
            alert("Analysis failed.");
        } finally {
            document.getElementById('loading-overlay').style.display = "none";
        }
    }

    function renderResult(res) {
        const t = i18n[currentLang] || i18n.en;
        const isSafe = res.status === "safe";
        document.getElementById('result-area').innerHTML = `
            <div class="alert-box ${isSafe ? 'alert-safe' : 'alert-critical'}">
                <span style="font-size:64px;">${isSafe ? 'üòä' : 'üò´'}</span>
                <h2>${isSafe ? t.safe : t.critical}</h2>
                <p><strong>${res.product_name}</strong></p>
                <p>${res.suitability_note}</p>
                <div>${(res.matches || []).map(m => `<span class="tag">${m}</span>`).join('')}</div>
                <details style="margin-top:15px; text-align:left; font-size:12px;">
                    <summary style="cursor:pointer; text-align:center;">Ingredients List</summary>
                    <div style="background:#fff; padding:10px; border-radius:10px; margin-top:5px; border:1px solid #eee;">${res.translated_ingredients}</div>
                </details>
            </div>
        `;
    }

    async function toggleTorch() {
        if (!cameraStream) return;
        const track = cameraStream.getVideoTracks()[0];
        const settings = track.getSettings();
        if (track.getCapabilities().torch) {
            await track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
        }
    }

    function saveSettings() {
        localStorage.setItem('my_diet', document.getElementById('my-diet').value);
        alert("Saved!");
    }

    function handleFileSelect(event) {
        const reader = new FileReader();
        reader.onload = (e) => analyze(e.target.result.split(',')[1]);
        reader.readAsDataURL(event.target.files[0]);
    }
</script>
</body>
</html>